openapi: 3.0.3
info:
  title: TicketTheatre Core Service API
  description: |
    API REST pour la gestion complète d'un système de réservation de spectacles de théâtre.

    ## Authentification
    Utilise Sanctum avec tokens Bearer. Obtenez un token via le Auth Service (`POST http://localhost:8081/api/login`).

    ## Base de données partagée
    Les services Auth et Core partagent la même base de données MySQL `db_core`.

  version: 1.0.0
  contact:
    email: romaricyt11@gmail.com

servers:
  - url: http://localhost:8082/api
    description: Core Service - Development
  - url: http://localhost:8081/api
    description: Auth Service - Development

tags:
  - name: Auth
    description: Authentification (Auth Service)
  - name: Categories
    description: Gestion des catégories de spectacles
  - name: Halls
    description: Gestion des salles
  - name: Spectacles
    description: Gestion des spectacles
  - name: Seances
    description: Gestion des séances
  - name: Reservations
    description: Gestion des réservations

paths:
  /login:
    post:
      tags:
        - Auth
      summary: Connexion utilisateur
      description: Authentifie un utilisateur et retourne un token Sanctum
      servers:
        - url: http://localhost:8081/api
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: admin@tickettheatre.com
                password:
                  type: string
                  format: password
                  example: password
      responses:
        "200":
          description: Authentification réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  token:
                    type: string
                    example: "1|abcdefghijklmnopqrstuvwxyz"
                  user:
                    $ref: "#/components/schemas/User"
        "422":
          description: Identifiants invalides
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"

  /public/categories:
    get:
      tags:
        - Categories
      summary: Liste des catégories
      description: Récupère toutes les catégories avec le nombre de spectacles
      responses:
        "200":
          description: Liste des catégories
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Category"

  /public/categories/{id}:
    get:
      tags:
        - Categories
      summary: Détails d'une catégorie
      parameters:
        - $ref: "#/components/parameters/IdPathParam"
      responses:
        "200":
          description: Détails de la catégorie
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/Category"

  /categories:
    post:
      tags:
        - Categories
      summary: Créer une catégorie
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CategoryInput"
      responses:
        "201":
          description: Catégorie créée
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    $ref: "#/components/schemas/Category"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "422":
          $ref: "#/components/responses/ValidationError"

  /categories/{id}:
    put:
      tags:
        - Categories
      summary: Modifier une catégorie
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/IdPathParam"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CategoryInput"
      responses:
        "200":
          description: Catégorie modifiée
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "404":
          $ref: "#/components/responses/NotFoundError"

    delete:
      tags:
        - Categories
      summary: Supprimer une catégorie
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/IdPathParam"
      responses:
        "200":
          description: Catégorie supprimée
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "422":
          description: Impossible de supprimer (spectacles associés)

  /public/spectacles:
    get:
      tags:
        - Spectacles
      summary: Liste des spectacles
      parameters:
        - name: category_id
          in: query
          schema:
            type: integer
        - name: status
          in: query
          schema:
            type: string
            enum: [upcoming, ongoing, finished, cancelled]
        - name: is_published
          in: query
          schema:
            type: boolean
        - name: search
          in: query
          schema:
            type: string
        - name: sort_by
          in: query
          schema:
            type: string
            default: created_at
        - name: sort_order
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 15
      responses:
        "200":
          description: Liste paginée des spectacles
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: "#/components/schemas/Spectacle"
                      current_page:
                        type: integer
                      total:
                        type: integer

  /public/spectacles/upcoming:
    get:
      tags:
        - Spectacles
      summary: Spectacles à venir
      description: Retourne les 10 derniers spectacles publiés avec séances à venir
      responses:
        "200":
          description: Liste des spectacles à venir

  /public/spectacles/{id}:
    get:
      tags:
        - Spectacles
      summary: Détails d'un spectacle
      parameters:
        - $ref: "#/components/parameters/IdPathParam"
      responses:
        "200":
          description: Détails du spectacle avec séances

  /spectacles:
    post:
      tags:
        - Spectacles
      summary: Créer un spectacle
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SpectacleInput"
      responses:
        "201":
          description: Spectacle créé
        "401":
          $ref: "#/components/responses/UnauthorizedError"

  /public/seances:
    get:
      tags:
        - Seances
      summary: Liste des séances
      parameters:
        - name: spectacle_id
          in: query
          schema:
            type: integer
        - name: hall_id
          in: query
          schema:
            type: integer
        - name: status
          in: query
          schema:
            type: string
            enum: [scheduled, cancelled, completed]
        - name: date_from
          in: query
          schema:
            type: string
            format: date
        - name: date_to
          in: query
          schema:
            type: string
            format: date
        - name: upcoming_only
          in: query
          schema:
            type: boolean
      responses:
        "200":
          description: Liste des séances

  /public/seances/{id}/available-seats:
    get:
      tags:
        - Seances
      summary: Places disponibles
      parameters:
        - $ref: "#/components/parameters/IdPathParam"
      responses:
        "200":
          description: Informations sur les places
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      total_seats:
                        type: integer
                        example: 500
                      booked_seats:
                        type: integer
                        example: 45
                      remaining_seats:
                        type: integer
                        example: 455
                      is_available:
                        type: boolean
                        example: true

  /seances:
    post:
      tags:
        - Seances
      summary: Créer une séance
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SeanceInput"
      responses:
        "201":
          description: Séance créée
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "422":
          description: Conflit de salle ou erreur de validation

  /reservations:
    get:
      tags:
        - Reservations
      summary: Liste des réservations
      security:
        - bearerAuth: []
      parameters:
        - name: user_id
          in: query
          schema:
            type: integer
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, confirmed, cancelled, expired]
        - name: payment_status
          in: query
          schema:
            type: string
            enum: [pending, paid, refunded, failed]
      responses:
        "200":
          description: Liste des réservations
        "401":
          $ref: "#/components/responses/UnauthorizedError"

    post:
      tags:
        - Reservations
      summary: Créer une réservation
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ReservationInput"
      responses:
        "201":
          description: Réservation créée
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    $ref: "#/components/schemas/Reservation"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "422":
          description: Places insuffisantes ou séance indisponible

  /public/reservations/reference/{reference}:
    get:
      tags:
        - Reservations
      summary: Réservation par référence
      description: Permet de consulter une réservation sans authentification
      parameters:
        - name: reference
          in: path
          required: true
          schema:
            type: string
            example: TH-2024-ABC123
      responses:
        "200":
          description: Détails de la réservation
        "404":
          description: Réservation non trouvée

  /reservations/{id}/confirm-payment:
    post:
      tags:
        - Reservations
      summary: Confirmer le paiement
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/IdPathParam"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - payment_id
              properties:
                payment_id:
                  type: string
                  example: PAY-STRIPE-123456
      responses:
        "200":
          description: Paiement confirmé
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "422":
          description: Réservation expirée ou déjà traitée

  /reservations/{id}/cancel:
    post:
      tags:
        - Reservations
      summary: Annuler une réservation
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/IdPathParam"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                cancellation_reason:
                  type: string
                  maxLength: 500
      responses:
        "200":
          description: Réservation annulée
        "401":
          $ref: "#/components/responses/UnauthorizedError"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token Sanctum obtenu via /login

  parameters:
    IdPathParam:
      name: id
      in: path
      required: true
      schema:
        type: integer

  responses:
    UnauthorizedError:
      description: Non authentifié
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              message:
                type: string
                example: Non authentifié. Token manquant ou invalide.

    NotFoundError:
      description: Ressource non trouvée
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              message:
                type: string
                example: Ressource non trouvée

    ValidationError:
      description: Erreur de validation
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              message:
                type: string
              errors:
                type: object

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
        first_name:
          type: string
        last_name:
          type: string
        full_name:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [user, admin]
        phone_number:
          type: string
        sex:
          type: string
        date_of_birth:
          type: string
          format: date
        avatar:
          type: string
        is_active:
          type: boolean

    Category:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        slug:
          type: string
        description:
          type: string
        icon:
          type: string
        color:
          type: string
        spectacles_count:
          type: integer

    CategoryInput:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          maxLength: 255
        description:
          type: string
        icon:
          type: string
        color:
          type: string
          pattern: "^#[a-fA-F0-9]{6}$"

    Spectacle:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        description:
          type: string
        duration:
          type: integer
        base_price:
          type: number
          format: float
        image_url:
          type: string
        poster_url:
          type: string
        trailer_url:
          type: string
        language:
          type: string
        age_restriction:
          type: integer
        category_id:
          type: integer
        director:
          type: string
        actors:
          type: array
          items:
            type: string
        is_published:
          type: boolean
        status:
          type: string
          enum: [upcoming, ongoing, finished, cancelled]

    SpectacleInput:
      type: object
      required:
        - title
        - base_price
      properties:
        title:
          type: string
        description:
          type: string
        duration:
          type: integer
          minimum: 1
        base_price:
          type: number
          minimum: 0
        image_url:
          type: string
          format: uri
        poster_url:
          type: string
          format: uri
        trailer_url:
          type: string
          format: uri
        language:
          type: string
          default: fr
        age_restriction:
          type: integer
          minimum: 0
          maximum: 18
        category_id:
          type: integer
        director:
          type: string
        actors:
          type: array
          items:
            type: string
        is_published:
          type: boolean
        status:
          type: string
          enum: [upcoming, ongoing, finished, cancelled]

    SeanceInput:
      type: object
      required:
        - spectacle_id
        - hall_id
        - date_seance
        - available_seats
        - price
      properties:
        spectacle_id:
          type: integer
        hall_id:
          type: integer
        date_seance:
          type: string
          format: date-time
        available_seats:
          type: integer
          minimum: 1
        price:
          type: number
          minimum: 0
        status:
          type: string
          enum: [scheduled, cancelled, completed]
          default: scheduled

    Reservation:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        seance_id:
          type: integer
        booking_reference:
          type: string
        seats:
          type: array
          items:
            type: string
        quantity:
          type: integer
        total_price:
          type: number
        status:
          type: string
          enum: [pending, confirmed, cancelled, expired]
        payment_status:
          type: string
          enum: [pending, paid, refunded, failed]
        payment_id:
          type: string
        expires_at:
          type: string
          format: date-time
        confirmed_at:
          type: string
          format: date-time
        cancelled_at:
          type: string
          format: date-time

    ReservationInput:
      type: object
      required:
        - user_id
        - seance_id
        - quantity
      properties:
        user_id:
          type: integer
        seance_id:
          type: integer
        quantity:
          type: integer
          minimum: 1
          maximum: 10
        seats:
          type: array
          items:
            type: string
            maxLength: 10

    ValidationError:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
        errors:
          type: object
